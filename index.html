<!DOCTYPE html>
<html>
  <meta charset="utf-8"/>
  <head>
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript" src="./nivoslider/jquery.nivo.slider.js"></script>
    <link rel="stylesheet" href="./nivoslider/themes/default.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="./nivoslider/nivo-slider.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="./css/main.css" type="text/css" media="screen" />
    <script>if (window.module) module = window.module;</script>
  </head>
  <body>
    <button onclick="getRandomCourse()">Give me a course!</button>
    <div id="courseName">Loading courses...</div>
    <div id="wrapper">
      <div class="slider-wrapper theme-default">
        <div id="slider" class="imgWrapper">
          <img id="img1" src="./images/loading.jpg" width="750">
          <img id="img2" src="./images/loading.jpg" width="750">
          <img id="img3" src="./images/loading.jpg" width="750">
        </div>
      </div>
    </div>
    <div id="courseDetails"></div>
    <div id="courses"></div>
  </body>
  <script>
    var courseData = [];

    $(document).ready(function(){
      $.getJSON('http://allorigins.me/get?url=' + encodeURIComponent('https://tgctours.com/Course/TGC2Listings?Grid-sort=DateCreated-desc&Grid-page=1&Grid-pageSize=50') + '&callback=?', function(data){
        var rows = $(data.contents).find('#Grid table tbody tr').each(function(index, element) {
          var courseElement = element.childNodes[2].firstChild;
          var designer = element.childNodes[5].textContent;
          var link = courseElement['href'];
          var index = link.indexOf("Course");
          link = link.substring(index);
          link = "https://tgctours.com/" + link;
          courseData.push({ courseName: courseElement.textContent, designer: designer, link: link});
        });
        console.log(courseData);
        getRandomCourse();
      });

      $('#slider').nivoSlider();
    });

    var getRandomCourse = function() {
      document.getElementById('courseName').innerText = "Loading course...";
      var courseImg = "./images/loading.jpg";
      for (let i = 1; i < 4; i++) {
        document.getElementById('img' + i)['src'] = courseImg;
      }

      var num = Math.floor((Math.random() * courseData.length) + 1) - 1;
      var courseInfo = courseData[num];
      getCourseDetails(courseInfo.link, courseInfo.courseName, courseInfo.designer);
    }

    var getCourseDetails = function(url, courseName, designer) {
      $.getJSON('http://allorigins.me/get?url=' + encodeURIComponent(url) + '&callback=?', function(data){
        var count = 1;
        $(data.contents).find('#slider > img').each(function(index, element) {
          if(count < 4) {
            var courseImg = element['src'];
            document.getElementById('img' + count)['src'] = courseImg;
            count = count + 1;
          }
        })
        document.getElementById('courseName').innerHTML = '<strong>' + courseName + '</strong> by ' + designer;
      });
    }
  </script>
</html> 